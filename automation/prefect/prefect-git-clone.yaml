prefect-version: null
name: null
description: "Deploy prefect flows with the latest POSSUM code from git."

#### building and pushing a prefect-compatible docker image is actually done
#### by the CIRADA-Tools/science-container github repo.
#### because we dont want to overload the images.canfar.net/harbor repository with many docker images

# build:
#  - prefect_docker.deployments.steps.build_docker_image:
#      id: build-image
#      requires: prefect-docker>=0.3.1
#      image_name: images.canfar.net/possumpipelineneprefect-{{ $VERSION }}
#      tag: "{{ $TAG }}"
#      dockerfile: auto

# push:
#  - prefect_docker.deployments.steps.push_docker_image:
#      requires: prefect-docker>=0.3.1
#      image_name: "{{ build-image.image_name }}"
#      tag: "{{ build-image.tag }}"

pull:
  - prefect.deployments.steps.git_clone:
      id: clone-step
      repository: https://github.com/ErikOsinga/POSSUMutils.git
      branch: main
  - prefect.deployments.steps.pip_install_requirements:
      requirements_file: requirements.txt
      directory: "{{ clone-step.directory }}"

deployments:
  - name: 3d-pipeline
    entrypoint: possum_pipeline_control/control_3D_pipeline.py:main_flow
    work_pool:
      name: local-pool
      work_queue_name: default
      job_variables:
        env:
          IMAGE: "images.canfar.net/cirada/possumpipelineprefect-{{ $VERSION }}:{{ $TAG }}"
          #pass it on to code at run time so we know which one to pull from Harbor for Canfar
    
  - name: 1d-pipeline-partial-tiles
    entrypoint: possum_pipeline_control/control_1D_pipeline_PartialTiles.py:main_flow
    work_pool:
      name: local-pool
      work_queue_name: default
      job_variables:
        env:
          IMAGE: "images.canfar.net/cirada/possumpipelineprefect-{{ $VERSION }}:{{ $TAG }}"

  - name: refresh-cadc-proxy-pem
    entrypoint: automation/prefect/refresh_cadc_proxy_pem.py:main
    description: 'Handy script to manually refresh cadcproxy.pem from Prefect secret if needed.'
    work_pool:
      name: local-pool
      work_queue_name: default

  - name: delete-state-file
    entrypoint: automation/prefect/delete_state_file.py:main
    description: 'Handy script to manually delete state file to allow create_symlinks to rerun.'
    work_pool:
      name: local-pool
      work_queue_name: default    

  - name: push-session-logs-to-canfar
    entrypoint: automation/canfar_polling.py:get_completed_sessions_logs    
    description: 'Schedule this to run after each parent flow to push Canfar session logs to Canfar directory.'
    work_pool:
      name: local-pool 
      work_queue_name: default
